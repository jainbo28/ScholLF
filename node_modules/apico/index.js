const fs = require('fs');
const { app, requireAllLocals, requireAllRoutes, requireAllMiddlewares } = require('./server.js');
const { view } = require('./view.js');
const { getAll : allLocals } = require('./locals.js');
var cookieParser = require('cookie-parser')

/** Import all routes */
requireAllRoutes();

/** Import all locals */
requireAllLocals();




// Set locals
app.use(async ( req, res, next)=>{

  res.locals = allLocals();
  next();
})


/// Setup cookies
app.use(cookieParser())

/** Import all middlewares */
requireAllMiddlewares();

/** All get routes which were not registred with requireAllRoutes functions will be considered as a route for an app. */
  app.get('/:param1?/:param2?/:param3?/:param4?', (req, res) => {
      let app_name = ( req.params.param1 ) ?? 'main';
      /// Get config file
      let config = {
        res: res,
        req: req
      };
      if( fs.existsSync( `./frontend/dist/apps/${app_name}/config.json` ) ) {
        let c = fs.readFileSync(`./frontend/dist/apps/${app_name}/config.json`, "utf8");
        config = JSON.parse( c );
      }
      else config = { layout: 'shared/layouts/default', access: "public" , exists: false};
      
      /// Pass req and res to ejs
      config.req = req;
      config.res = res;
      
      if( fs.existsSync( `./frontend/dist/apps/${app_name}/index.ejs` ) ) {
          config.app_name = app_name; config.title = 'test';
          if( config.access !== 'public' && !req.app.locals.user ) {
            res.cookie('redirect_to', app_name );
            res.redirect('/login');
          } else if ( req.app.locals.user && ['login', 'registration'].includes( app_name ) ) {
            res.redirect('/');
          }else{
            view( res, config);
          }
          
      }else {
        res.redirect('/notfound');
      }
    
  })
/** Not found page */
app.all('*', ( req, res )=>{
  res.json({"message":"Not found!"});
});



